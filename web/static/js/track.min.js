// Command Center Tracking Script v0.1.0
(function() {
  'use strict';

  // Configuration
  var config = window.CC_CONFIG || {};
  var endpoint = config.endpoint || (function() {
    var scripts = document.getElementsByTagName('script');
    for (var i = 0; i < scripts.length; i++) {
      if (scripts[i].src && scripts[i].src.indexOf('track.min.js') > -1) {
        return scripts[i].src.replace('/static/js/track.min.js', '/track');
      }
    }
    return 'http://localhost:4698/track';
  })();

  var domain = config.domain || window.location.hostname;
  var tags = config.tags || [];

  // Track event function
  function track(eventType, data) {
    data = data || {};

    var payload = {
      h: domain,
      p: data.path || window.location.pathname,
      e: eventType || 'pageview',
      t: tags.concat(data.tags || []),
      ref: data.referrer || document.referrer,
      q: data.query || {}
    };

    // Send beacon
    if (navigator.sendBeacon) {
      navigator.sendBeacon(endpoint, JSON.stringify(payload));
    } else {
      // Fallback to fetch
      fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        keepalive: true
      }).catch(function() {
        // Silent failure
      });
    }
  }

  // Auto-track pageview
  if (config.autoTrack !== false) {
    track('pageview');
  }

  // Track clicks with data-cc-track attribute
  document.addEventListener('click', function(e) {
    var target = e.target;
    while (target && target !== document) {
      if (target.hasAttribute && target.hasAttribute('data-cc-track')) {
        track('click', {
          path: target.getAttribute('href') || target.getAttribute('data-cc-path'),
          tags: (target.getAttribute('data-cc-tags') || '').split(',').filter(Boolean)
        });
        break;
      }
      target = target.parentNode;
    }
  });

  // Track form submissions
  document.addEventListener('submit', function(e) {
    var form = e.target;
    if (form.hasAttribute && form.hasAttribute('data-cc-track')) {
      track('submit', {
        path: form.getAttribute('action') || window.location.pathname,
        tags: (form.getAttribute('data-cc-tags') || '').split(',').filter(Boolean)
      });
    }
  });

  // Expose global track function
  window.ccTrack = track;

  // Track visibility changes (user leaving/returning)
  var startTime = Date.now();
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      var duration = Math.round((Date.now() - startTime) / 1000);
      track('visibility', {
        query: { duration: duration }
      });
    } else {
      startTime = Date.now();
    }
  });

})();
